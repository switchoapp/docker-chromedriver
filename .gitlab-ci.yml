default:
    image: docker:20.10
    retry: 1

services:
    - name: docker:20.10-dind
      alias: docker

stages:
    - build

build chromedriver:
    stage: build
    variables:
        BUILDX_VERSION: 0.6.3
    before_script:
        - apk add --no-cache curl
        - mkdir -p /usr/lib/docker/cli-plugins
        - curl -L --output /usr/lib/docker/cli-plugins/docker-buildx "https://github.com/docker/buildx/releases/download/v${BUILDX_VERSION}/buildx-v${BUILDX_VERSION}.linux-amd64"
        - chmod a+x /usr/lib/docker/cli-plugins/docker-buildx
        - docker buildx create --use

    script:
        - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ${CI_REGISTRY}
        - docker buildx build \
            --platform linux/arm64/v8,linux/amd64 \
            -t ${CI_REGISTRY_IMAGE} --push .

    after_script:
        - docker buildx rm
